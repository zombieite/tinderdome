# Set up an elastic IP, or use an existing one, and associate it to the instance
# Make sure Route 53 connects youareawaited.com to that elastic IP
ssh ec2-user@<your elastic IP>
# Add an A record connecting *.youareawaited.com to that IP in Amazon Route 53, don't forget that * at the beginning
ssh ec2-user@youareawaited.com
# Create a reverse DNS for the IP to make emails from your domain not be seen as spam 
alias server='ssh ec2-user@youareawaited.com'
server
# Update system packages (Amazon Linux 2023 uses dnf)
sudo dnf update -y
# Install Apache HTTP Server and SSL support
sudo dnf install -y httpd httpd-tools mod_ssl
# Enable Apache to start on boot
sudo systemctl enable httpd
# Verify Apache is enabled
sudo systemctl is-enabled httpd
# Start Apache now
sudo systemctl start httpd
# Verify Apache is running
sudo systemctl status httpd --no-pager
# http://youareawaited.com should show Apache test homepage, note not using SSL yet
######################################################################################
# Website html and stuff will be at /var/www/html/ ###################################
######################################################################################
sudo dnf install -y --allowerasing curl
curl --version
sudo dnf install -y git unzip php php-cli php-common php-mbstring php-xml php-json php-zip php-gd php-intl php-opcache php-pdo php-mysqlnd
php -v
git --version
php -m | egrep -i 'gd|mbstring|xml|intl|pdo|mysqlnd'
cd /tmp && php -r "copy('https://getcomposer.org/installer','composer-setup.php');" && sudo php composer-setup.php --install-dir=/usr/local/bin --filename=composer && rm composer-setup.php
sudo dnf install -y mariadb105-server && sudo systemctl enable --now mariadb && sudo mariadb-secure-installation
# set a root password
# answer Y to removing anonymous users
# Y to disallow remote root login
# Y to remove test database
# Y to reload privilege tables
# Change password below
sudo mariadb -u root -p -e "CREATE DATABASE tinderdome CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci; CREATE USER tinderdome@'localhost' IDENTIFIED BY 'password'; GRANT ALL PRIVILEGES ON tinderdome.* TO tinderdome@'localhost'; FLUSH PRIVILEGES; SHOW DATABASES; SELECT user,host FROM mysql.user;"
echo "<?php phpinfo(); ?>" | sudo tee /var/www/html/info.php >/dev/null && sudo chown root:root /var/www/html/info.php && sudo chmod 644 /var/www/html/info.php && sudo systemctl reload httpd
sudo dnf install -y php-fpm && sudo systemctl enable --now php-fpm && sudo systemctl status php-fpm --no-pager && sudo systemctl reload httpd
# Check https://youareawaited.com/info.php, see if it shows PHP info
# Replace PHP info with "Hello world"
echo "<?php echo 'Hello world';" | sudo tee /var/www/html/index.php >/dev/null && sudo chown root:root /var/www/html/index.php && sudo chmod 644 /var/www/html/index.php && sudo systemctl reload httpd
sudo rm /var/www/html/info.php
# Access log
tail -f  /var/log/httpd/access_log
# Error log
tail -f /var/log/httpd/error_log
composer --version && composer diagnose
composer self-update --update-keys
# This "myapp" stuff gets renamed later so next time through, just do this my way from the start
cd /var/www && sudo mkdir -p myapp && sudo chown -R ec2-user:apache myapp && cd myapp && composer create-project laravel/laravel .
$ cd /var/www/myapp && php artisan --version
ssh-keygen
cat /home/ec2-user/.ssh/id_rsa.pub
# Add that key to github
# Create vhost file at /etc/httpd/conf.d/youareawaited.com.conf
<VirtualHost *:80>
    ServerAdmin email@email.com
    ServerName youareawaited.com
    ServerAlias www.youareawaited.com
    DocumentRoot /var/www/html/tinderdome/public
    <Directory /var/www/html/tinderdome/public>
        AllowOverride All
        Require all granted
    </Directory>
    ErrorLog /var/log/httpd/youareawaited.com-error_log
    CustomLog /var/log/httpd/youareawaited.com-access_log combined
</VirtualHost>
# And this one too: /etc/httpd/conf.d/00-youareawaited-ssl.conf
Listen 443
SSLSessionCache shmcb:/run/httpd/sslcache(512000)
<VirtualHost *:443>
    ServerAdmin email@email.com
    ServerName youareawaited.com
    ServerAlias www.youareawaited.com
    DocumentRoot /var/www/html/tinderdome/public
    <Directory /var/www/html/tinderdome/public>
        AllowOverride All
        Require all granted
        Options -Indexes
    </Directory>
    SSLEngine on
    SSLCertificateFile /etc/pki/tls/certs/localhost.crt
    SSLCertificateKeyFile /etc/pki/tls/private/localhost.key
    ErrorLog /var/log/httpd/youareawaited.com-ssl-error_log
    CustomLog /var/log/httpd/youareawaited.com-ssl-access_log combined
</VirtualHost>
# Just modify what ChatGPT suggested before, to fit my normal install better
sudo mv /var/www/myapp /var/www/html/tinderdome && sudo chown -R ec2-user:apache /var/www/html/tinderdome
# Set up rewrites
sudo sed -i 's/^#LoadModule rewrite_module/LoadModule rewrite_module/' /etc/httpd/conf.modules.d/00-base.conf && sudo systemctl reload httpd
# Set up permissions
sudo chown -R ec2-user:apache /var/www/html/tinderdome/storage /var/www/html/tinderdome/bootstrap/cache && sudo find /var/www/html/tinderdome/storage /var/www/html/tinderdome/bootstrap/cache -type d -exec chmod 775 {} \; && sudo find /var/www/html/tinderdome/storage /var/www/html/tinderdome/bootstrap/cache -type f -exec chmod 664 {} \; && sudo systemctl reload httpd
sudo mkdir -p /var/www/html/tinderdome/database && sudo touch /var/www/html/tinderdome/database/database.sqlite && sudo chown -R ec2-user:apache /var/www/html/tinderdome/database && sudo chmod 775 /var/www/html/tinderdome/database && sudo chmod 664 /var/www/html/tinderdome/database/database.sqlite && sudo systemctl reload httpd
sudo rm /var/www/html/index.php
# Make apache use my config
sudo mv /etc/httpd/conf.d/welcome.conf /etc/httpd/conf.d/welcome.conf.disabled && sudo mv /etc/httpd/conf.d/youareawaited.com.conf /etc/httpd/conf.d/00-youareawaited.com.conf && sudo apachectl configtest && sudo systemctl reload httpd
apachectl configtest
# Get rid of unneeded SSL conf
sudo mv /etc/httpd/conf.d/ssl.conf /etc/httpd/conf.d/ssl.conf.disabled
sudo systemctl reload httpd
sudo systemctl restart httpd
######################################################################################
# Site configurations are in /etc/httpd/conf.d/ ######################################
# Access log is at /var/log/httpd/youareawaited.com-access_log #######################
# Error log is at /var/log/httpd/youareawaited.com-error_log #########################
######################################################################################
# Check the site, it should show Laravel welcome page
# Now put .env into place
cd /var/www/html/tinderdome && cp -n .env.example .env && php artisan key:generate --force && perl -0777 -i -pe "s/DB_CONNECTION=.*/DB_CONNECTION=mysql/; s/DB_HOST=.*/DB_HOST=127.0.0.1/; s/DB_PORT=.*/DB_PORT=3306/; s/DB_DATABASE=.*/DB_DATABASE=DB_NAME/; s/DB_USERNAME=.*/DB_USERNAME=DB_USER/; s/DB_PASSWORD=.*/DB_PASSWORD=DB_PASSWORD/;" .env
# Go into .env and uncomment things and set up DB creds that we created above
cd /var/www/html/tinderdome && sudo php artisan optimize:clear && sudo php artisan migrate --force
# Also add or change the lines CACHE_DRIVER=file, CACHE_STORE=file, SESSION_DRIVER=file, APP_DEBUG=false 
cd /var/www/html/tinderdome && php artisan migrate --force
cd /var/www/html/tinderdome && composer require intervention/image-laravel
# Test image generation
cd /var/www/html/tinderdome && sudo cp -a routes/web.php routes/web.php.bak.$(date +%Y%m%d%H%M%S) && sudo bash -c "cat >> routes/web.php <<'PHP'
use Intervention\\Image\\Laravel\\Facades\\Image;
Route::get('/img-test', function () {
    \$img = Image::create(600, 200)->fill('ccc')->drawCircle(100, 100, function (\$circle) {
        \$circle->radius(80);
        \$circle->border('000', 6);
        \$circle->background('09f');
    });
    return response()->image(\$img, 'png');
});
PHP"
cd /var/www/html/tinderdome && php artisan optimize:clear
# Check URL https://youareawaited.com/img-test
######################################################################################
# Images at /var/www/html/tinderdome/public/uploads ##################################
# Laravel error log at /var/www/html/tinderdome/storage/logs/laravel.log #############
# Access mysql: mysql -u tinderdome -p ###############################################
######################################################################################
cd
mkdir mysqldumps
# Now from home machine
scp ~/Desktop/server/mysqldumps/mysqldump.sql ec2-user@youareawaited.com:~/mysqldumps/mysqldump.initial.sql
server
mysql -utinderdome -p tinderdome < /home/ec2-user/mysqldumps/mysqldump.initial.sql
######################################################################################
# Mysql backups are at /home/ec2-user/mysqldumps/ ####################################
######################################################################################
cd
# Make sure NOT logged in as root for this next step
git clone git@github.com:zombieite/tinderdome.git
######################################################################################
# Repo is at /home/ec2-user/tinderdome ###############################################
######################################################################################
# Now that it's working, save this working state
sudo cp -a /var/www/html/tinderdome /var/www/html/tinderdome_baseline_$(date +%Y%m%d%H%M%S)
# Command to copy my code into place
sudo rsync -av --exclude='.*' --exclude 'storage/' --exclude 'bootstrap/cache/' --exclude 'vendor/' /home/ec2-user/tinderdome/ /var/www/html/tinderdome/
# Fix permissions for Apache
sudo chown -R ec2-user:apache /var/www/html/tinderdome/storage /var/www/html/tinderdome/bootstrap/cache && sudo find /var/www/html/tinderdome/storage /var/www/html/tinderdome/bootstrap/cache -type d -exec chmod 2775 {} \; && sudo find /var/www/html/tinderdome/storage /var/www/html/tinderdome/bootstrap/cache -type f -exec chmod 664 {} \; && sudo restorecon -RFv /var/www/html/tinderdome/storage /var/www/html/tinderdome/bootstrap/cache >/dev/null 2>&1 || true
# Oops one more (probably redundant with last one but adds a little more permissions)
sudo chown -R ec2-user:apache /var/www/html/tinderdome && sudo find /var/www/html/tinderdome -type d -exec chmod 2755 {} \; && sudo find /var/www/html/tinderdome -type f -exec chmod 0644 {} \; && sudo find /var/www/html/tinderdome/storage /var/www/html/tinderdome/bootstrap/cache -type d -exec chmod 2775 {} \; && sudo find /var/www/html/tinderdome/storage /var/www/html/tinderdome/bootstrap/cache -type f -exec chmod 0664 {} \;
cd /var/www/html/tinderdome && composer require laravel/ui
cd /var/www/html/tinderdome && composer install --no-dev --optimize-autoloader && php artisan optimize:clear
# http://youareawaited.com should show YAA homepage
# Send over all image uploads
rsync -rv --size-only ~/Desktop/server/uploads/ ec2-user@youareawaited.com:/var/www/html/tinderdome/public/uploads/
sudo chown -R ec2-user:apache /var/www/html/tinderdome/public/uploads && sudo find /var/www/html/tinderdome/public/uploads -type d -exec chmod 2775 {} \; && sudo find /var/www/html/tinderdome/public/uploads -type f -exec chmod 664 {} \; && sudo restorecon -RFv /var/www/html/tinderdome/public/uploads >/dev/null 2>&1 || true
rsync -rv --size-only ~/Desktop/local/web/tinderdome/public/images/stories/ ec2-user@youareawaited.com:/var/www/html/tinderdome/public/stories/
# Set up some old fashioned stuff I haven't bothered to update
cd /var/www/html/tinderdome && composer remove intervention/image-laravel --no-scripts && composer require intervention/image:^2.7 --no-scripts && php artisan optimize:clear
cd /var/www/html/tinderdome && composer install --no-dev --optimize-autoloader && php artisan optimize:clear
sudo vi /etc/php.d/99-tinderdome.ini
# post_max_size = 40M
# upload_max_filesize = 40M
sudo systemctl restart php-fpm
# Get SSL working right
sudo dnf install -y certbot python3-certbot-apache
certbot --version
sudo certbot --apache -d youareawaited.com -d www.youareawaited.com
echo | openssl s_client -servername youareawaited.com -connect youareawaited.com:443 2>/dev/null | openssl x509 -noout -subject -issuer -dates
# Check 80 to 443 redirect works
curl -sS -D- http://youareawaited.com/ -o /dev/null
sudo certbot renew --dry-run
sudo systemctl list-unit-files | grep -i certbot || true
sudo systemctl enable --now certbot-renew.timer
sudo systemctl list-unit-files | grep -i certbot || true
sudo systemctl list-timers | grep -i certbot
# To manually renew if timer doesn't work: certbot renew --no-self-upgrade
# Set up bash profile 
vi ~/.bash_profile
PATH=$PATH:$HOME/.local/bin:$HOME/bin:$HOME/code
export PATH
eval `ssh-agent`
alias mysq='mysql -utinderdome -p`grep DB_PASSWORD /var/www/html/tinderdome/.env | cut -d= -f2` tinderdome'
cat /var/www/html/tinderdome/storage/logs/laravel.log
echo "echo ''>/var/www/html/tinderdome/storage/logs/laravel.log # To remove laravel log file above (don't delete it)"
ssh-add
# How to reboot everything
sudo shutdown -r now
sudo reboot
# Or
https://us-east-2.console.aws.amazon.com/ec2/v2/home?region=us-east-2#Instances:instanceState=running
# Instance state -> Reboot instance
